{% extends 'renosic_app/base.html' %}
{% block title %}{{ customer.company_name }}ã®è©³ç´°{% endblock %}

{% block content %} 
<div class="d-flex justify-content-between align-items-center mb-3">
    <h1>{{ customer.company_name }}</h1>
    <div>
        <a href="{% url 'customer_update' customer.pk %}" class="btn btn-secondary">[ç·¨é›†ã™ã‚‹]</a>
        <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteConfirmModal">
            [å‰Šé™¤ã™ã‚‹]
        </button>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <p><strong>æ‹…å½“è€…å:</strong> {{ customer.contact_name }}</p>
        <p><strong>ãƒ¡ãƒ¼ãƒ«:</strong> {{ customer.email }}</p>
    </div>
</div>

<h3 class="mt-4">å•†è«‡å±¥æ­´:</h3>
<div class="card mb-3 bg-light">
    <div class="card-body">
        <h6 class="card-tittle">å•†è«‡ã‚’ã‚¯ãƒªãƒƒã‚¯è¿½åŠ </h6>
    <form id="activity-form">
        {% csrf_token %}
        <input type="hidden" name="customer_id" value="{{ customer.id }}">

        <div class="row g-2">
            <div class="col-md-3">
                <input type="date" name="activity_date" class="form-control" required>
            </div>
            <div class="col-md-3">
                <select name="status" class="form-select">
                    <option value ="APPO">ã‚¢ãƒ</option>
                    <option value ="MEETING">å•†è«‡ä¸­</option>
                    <option value ="PROPOSAL">ææ¡ˆä¸­</option>
                    <option value ="WON">å—æ³¨</option>
                    <option value ="LOST">å¤±æ³¨</option>
                </select>
            </div>
            <div class="col-md-4">
                <input type="text" name="note" class="form-control" placeholder="ãƒ¡ãƒ¢ã‚’å…¥åŠ›" required>
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary w-100">è¿½åŠ </button> </div>
        </div>
    </form>
    </div>
</div>
<div class="card">
    <div class="card-body" id="activity-list"> {% for activity in customer.activity_set.all|dictsortreversed:"activity_date" %}
            <div class="mb-2">
                <strong>{{ activity.activity_date }}</strong>
                ï¼ˆ{{ activity.get_status_display }}ï¼‰<br>
                {{ activity.note }}
            </div>
            {% if not forloop.last %}<hr>{% endif %}
        {% empty %}
            <p class="text-muted" id="no-activity-msg">å•†è«‡å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p> {% endfor %}
    </div>
</div>

<a href="{% url 'customer_list' %}" class="btn btn-outline-primary">ä¸€è¦§ã«æˆ»ã‚‹</a>

<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">å‰Šé™¤ã®ç¢ºèª</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="é–‰ã˜ã‚‹"></button>
            </div>
            <div class="modal-body">
                æœ¬å½“ã« {{ customer.company_name }} ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ<br>ã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <form action="{% url 'customer_delete' customer.pk %}" method="POST" style="display:inline">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">ã¯ã„ã€å‰Šé™¤ã—ã¾ã™</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    document.getElementById('activity-form').addEventListener('submit',function(e){
        e.preventDefault(); // ğŸ‘ˆ e.preeventDefault() ã‚’ä¿®æ­£
        const form = this;
        const formData = new FormData(form);
        const url = "{% url 'ajax_add_activity' %}";

        fetch(url,{ // ğŸ‘ˆ ffetch ã‚’ä¿®æ­£
            method: 'POST',
            body: formData,
            headers:{
                'X-Requested-With':'XMLHttpRequest'
            }
        })
        .then(response => {
            if(!response.ok){
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            const noMsg = document.getElementById('no-activity-msg');
            if(noMsg)noMsg.remove();

            const list = document.getElementById('activity-list'); // ğŸ‘ˆ ID 'activity-list' ã‚’å‚ç…§
            
            // æ—¢å­˜ã®HTMLæ§‹é€  (<div>ã¨<hr>) ã«åˆã‚ã›ã‚‹
            const newItemContainer = document.createElement('div');
            
            // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ã‚­ãƒ¼åãŒä¸æ˜ãªãŸã‚ã€status_displayã‚’ä»®å®šã—ã¾ã™
            const statusDisplay = data.status_display || data.status;

            newItemContainer.innerHTML =`
                <div class="mb-2">
                    <strong>${data.activity_date}</strong>
                    ï¼ˆ${statusDisplay}ï¼‰<br>
                    ${data.note}
                </div>
                <hr>
            `;
            
            // ãƒªã‚¹ãƒˆã®å…ˆé ­ã«è¿½åŠ 
            list.prepend(newItemContainer.lastChild); // <hr>
            list.prepend(newItemContainer.firstChild); // <div>
            
            form.reset(); // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ

        })
        .catch(error => {
            console.error('Error:',error);
            alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
        })
    })
</script>
{% endblock %}